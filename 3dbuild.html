<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Building Downloader</title>
<link href="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<style>
  body { margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  #map { position:absolute; top:0; bottom:0; width:100%; }

  #toolbar {
    position: absolute;
    top: 15px;
    left: 15px;
    z-index: 9999;
    display: flex;
    gap: 10px;
    background: rgba(255, 255, 255, 0.95);
    padding: 10px 12px;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    align-items: center;
  }

  #sizeButtons { display:flex; gap:6px; }
  .sizeBtn { background:#fff; border:2px solid #4CAF50; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; }
  .sizeBtn.active { background:#4CAF50; color:white; }
  .sizeBtn:hover { background:#4CAF5022; }

  #downloadBtn {
    background: #4CAF50;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease-in-out;
  }

  #downloadBtn:hover { background:#45a049; }

  #searchBox { width:220px; padding:8px 12px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
</style>
</head>
<body>

<div id="toolbar">
  <div id="sizeButtons">
    <button class="sizeBtn" data-size="1">1 mi²</button>
    <button class="sizeBtn" data-size="2">2 mi²</button>
    <button class="sizeBtn" data-size="3">3 mi²</button>
  </div>
  <input type="text" id="searchBox" placeholder="Search location... (Press Enter)" />  
  <button id="downloadBtn">Download GeoJSON</button> 
</div>
<div id="map"></div>

<script>
const proj4326 = proj4("EPSG:4326");
const proj3857 = proj4("EPSG:3857");
let lastGeoJSON = { type: "FeatureCollection", features: [] };
let currentMiles = 1;
let currentController = null;
let buildingUpdateTimeout = null;

function reproj(c) { return proj4(proj3857, proj4326, c); }
function reprojectGeometry(geom) {
    if (geom.type === "Polygon") return { type:"Polygon", coordinates:geom.coordinates.map(ring=>ring.map(reproj)) };
    if (geom.type === "MultiPolygon") return { type:"MultiPolygon", coordinates:geom.coordinates.map(poly=>poly.map(ring=>ring.map(reproj))) };
    return geom;
}

const map = new maplibregl.Map({
    style: 'https://tiles.openfreemap.org/styles/positron',
    center: [-0.092, 51.515],   
    zoom: 15,
    pitch: 60,
    container: 'map',
});

map.addControl(new maplibregl.NavigationControl());
map.addControl(new maplibregl.AttributionControl({ compact:true }));

map.on("load", () => {
  map.addSource("buildings", { type:"geojson", data:{ type:"FeatureCollection", features:[] } });
  map.addLayer({ id:"buildings-3d", type:"fill-extrusion", source:"buildings", paint:{ "fill-extrusion-color":"#888", "fill-extrusion-height":["coalesce", ["get","height"], 10], "fill-extrusion-opacity":0.9 }});
  updateBuildings();
});

document.querySelectorAll(".sizeBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    currentMiles = parseInt(btn.dataset.size);
    document.querySelectorAll(".sizeBtn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    updateBuildings();
  });
});
document.querySelector('.sizeBtn[data-size="1"]').classList.add("active");

async function updateBuildings() {
    if (currentController) currentController.abort();
    currentController = new AbortController();

    const center = map.getCenter();
    const center3857 = proj4(proj4326, proj3857, [center.lng, center.lat]);

    const metersPerMile = 1609.34;
    const halfSize = (currentMiles * metersPerMile) / 2;

    const minX = center3857[0] - halfSize;
    const maxX = center3857[0] + halfSize;
    const minY = center3857[1] - halfSize;
    const maxY = center3857[1] + halfSize;
    const bbox = `${minX},${minY},${maxX},${maxY},EPSG:3857`;

    const url =
      "https://tubvsig-so2sat-vm1.srv.mwn.de/geoserver/ows?" +
      "service=WFS&version=2.0.0&request=GetFeature&" +
      "typeNames=global3D:lod1_global&" +
      "outputFormat=application/json&" +
      `bbox=${bbox}&srsName=EPSG:3857`;

    try {
      const response = await fetch(url, { signal: currentController.signal });
      const json = await response.json();
      json.features = json.features.map(f=>({...f, geometry:reprojectGeometry(f.geometry)}));
      lastGeoJSON = json;
      map.getSource("buildings").setData(json);
    } catch (e) { if (e.name !== "AbortError") console.error(e); }
}

map.on("moveend", () => {
    clearTimeout(buildingUpdateTimeout);
    buildingUpdateTimeout = setTimeout(updateBuildings, 400);
});

document.getElementById("downloadBtn").onclick = () => {
    const blob = new Blob([JSON.stringify(lastGeoJSON,null,2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const center = map.getCenter();
    a.download = `globalbuilding_${center.lng.toFixed(5)}_${center.lat.toFixed(5)}.geojson`;
    a.click();
    URL.revokeObjectURL(a.href);
};

document.getElementById("searchBox").addEventListener("keydown", async function(e){
    if(e.key === "Enter"){
        const query = this.value;
        if(!query) return;
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
        try {
            const response = await fetch(url, {headers:{'Accept-Language':'en'}});
            const data = await response.json();
            if(data.length){ map.flyTo({ center:[parseFloat(data[0].lon), parseFloat(data[0].lat)], zoom:17 }); }
            else alert("Location not found.");
        } catch(err){ alert("Search failed."); }
    }
});
</script>
</body>
</html>
