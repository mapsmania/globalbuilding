<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Building Downloader</title>

<link href="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<style>
body { margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
#map { position:absolute; top:0; bottom:0; width:100%; }

#toolbar {
  position:absolute;
  top:15px;
  left:15px;
  z-index:9999;
  display:flex;
  gap:10px;
  background:rgba(255,255,255,0.95);
  padding:10px 12px;
  border-radius:12px;
  box-shadow:0 6px 12px rgba(0,0,0,0.25);
  align-items:center;
}

#downloadBtn {
  background:#4CAF50;
  color:white;
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
}

#searchBox {
  width:220px;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}

#splash {
  position:fixed;
  inset:0;
  background:linear-gradient(135deg, rgba(0,0,0,0.95), rgba(30,30,30,0.9));
  color:white;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  z-index:10000;
  transition:opacity 0.7s ease, transform 0.7s ease;
}

#splash.hidden {
  opacity:0;
  transform:translateY(-50px);
  pointer-events:none;
}

#startBtn {
  margin-top:30px;
  padding:12px 30px;
  font-size:18px;
  font-weight:700;
  background:#4CAF50;
  border:none;
  border-radius:10px;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- Splash Screen -->
<div id="splash">
  <h1>Global Building Atlas Downloader</h1>
  <p>Download Global Building Atlas GeoJSON for a 1-mile square around the map center.</p>
  <button id="startBtn">Start</button>
</div>

<!-- Toolbar -->
<div id="toolbar">
  <input type="text" id="searchBox" placeholder="Search location... (Press Enter)">
  <button id="downloadBtn">Download GeoJSON</button>
</div>

<div id="map"></div>

<script>
/* -----------------------------
   Projections
----------------------------- */
const proj4326 = proj4("EPSG:4326");
const proj3857 = proj4("EPSG:3857");

function reproj(c) {
  return proj4(proj3857, proj4326, c);
}

function reprojectGeometry(geom) {
  if (geom.type === "Polygon")
    return { type:"Polygon", coordinates: geom.coordinates.map(r => r.map(reproj)) };

  if (geom.type === "MultiPolygon")
    return { type:"MultiPolygon", coordinates: geom.coordinates.map(p => p.map(r => r.map(reproj))) };

  return geom;
}

/* -----------------------------
   Map Initialization
----------------------------- */
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.openfreemap.org/styles/positron',
  center: [-0.092, 51.515],
  zoom: 15,
  pitch: 60
});

map.addControl(new maplibregl.NavigationControl());
map.addControl(new maplibregl.AttributionControl({
  compact: true,
  customAttribution:
    '<a href="https://github.com/zhu-xlab/GlobalBuildingAtlas" target="_blank">Global Building Atlas</a>'
}));

map.on("load", () => {
  // ⚠️ No building layers or WFS calls here
});

/* -----------------------------
   Splash Screen
----------------------------- */
document.getElementById("startBtn").onclick = () => {
  document.getElementById("splash").classList.add("hidden");
};

/* -----------------------------
   Download Button (ONLY WFS CALL)
----------------------------- */
document.getElementById("downloadBtn").onclick = async () => {
  const center = map.getCenter();
  const center3857 = proj4(proj4326, proj3857, [center.lng, center.lat]);
  const halfMile = 800;

  const minX = center3857[0] - halfMile;
  const maxX = center3857[0] + halfMile;
  const minY = center3857[1] - halfMile;
  const maxY = center3857[1] + halfMile;

  const bbox = `${minX},${minY},${maxX},${maxY},EPSG:3857`;

  const url =
    "https://tubvsig-so2sat-vm1.srv.mwn.de/geoserver/ows?" +
    "service=WFS&version=2.0.0&request=GetFeature&" +
    "typeNames=global3D:lod1_global&" +
    "outputFormat=application/json&" +
    `bbox=${bbox}&srsName=EPSG:3857`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error("WFS request failed");

    const json = await response.json();
    json.features = json.features.map(f => ({
      ...f,
      geometry: reprojectGeometry(f.geometry)
    }));

    const blob = new Blob([JSON.stringify(json, null, 2)], {
      type: "application/json"
    });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download =
      `globalbuilding_${center.lng.toFixed(5)}_${center.lat.toFixed(5)}.geojson`;
    a.click();
    URL.revokeObjectURL(a.href);

  } catch (err) {
    console.error(err);
    alert("Download failed. Please try again later.");
  }
};

/* -----------------------------
   Nominatim Search (NO WFS)
----------------------------- */
document.getElementById("searchBox").addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;
  if (!e.target.value) return;

  const url =
    `https://nominatim.openstreetmap.org/search?` +
    `q=${encodeURIComponent(e.target.value)}&format=json&limit=1`;

  try {
    const res = await fetch(url, { headers: { 'Accept-Language': 'en' }});
    const data = await res.json();
    if (data.length) {
      map.flyTo({
        center: [parseFloat(data[0].lon), parseFloat(data[0].lat)],
        zoom: 17
      });
    } else {
      alert("Location not found.");
    }
  } catch (err) {
    alert("Search failed.");
  }
});
</script>

</body>
</html>
