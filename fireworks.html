<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MapLibre 3D Buildings with Fireworks</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
  href="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.css"
  rel="stylesheet"
/>
<script src="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>

<body>
<div id="map"></div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';

/* --------------------------------------------------
   Map initialization
-------------------------------------------------- */

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.openfreemap.org/styles/positron',
  center: [-0.092, 51.515],
  zoom: 16,
  pitch: 60,
  bearing: -20
});

map.addControl(new maplibregl.NavigationControl());

/* --------------------------------------------------
   Firework helper
-------------------------------------------------- */

function createFirework(position) {
  const count = 300;
  const geometry = new THREE.BufferGeometry();
  const positions = new Float32Array(count * 3);
  const velocities = [];

  for (let i = 0; i < count; i++) {
    positions[i * 3] = 0;
    positions[i * 3 + 1] = 0;
    positions[i * 3 + 2] = 0;

    velocities.push({
      x: (Math.random() - 0.5) * 10,
      y: Math.random() * 12,
      z: (Math.random() - 0.5) * 10
    });
  }

  geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

  const material = new THREE.PointsMaterial({
    color: new THREE.Color().setHSL(Math.random(), 1, 0.6),
    size: 6,
    sizeAttenuation: false
  });

  const points = new THREE.Points(geometry, material);
  points.userData.velocities = velocities;
  points.position.copy(position);

  return points;
}

/* --------------------------------------------------
   Map load
-------------------------------------------------- */

map.on('load', async () => {

  /* ---------- Load buildings ---------- */

  const proj3857 = proj4('EPSG:3857');
  const proj4326 = proj4('EPSG:4326');

  function reprojectCoord(coord) {
    return proj4(proj3857, proj4326, coord);
  }

  function reprojectGeometry(geom) {
    if (geom.type === "Polygon") {
      return {
        type: "Polygon",
        coordinates: geom.coordinates.map(r => r.map(reprojectCoord))
      };
    }
    if (geom.type === "MultiPolygon") {
      return {
        type: "MultiPolygon",
        coordinates: geom.coordinates.map(p =>
          p.map(r => r.map(reprojectCoord))
        )
      };
    }
    return geom;
  }

  const buildings = await fetch(
    'https://mapsmania.github.io/globalbuilding/building.geojson'
  ).then(r => r.json());

  buildings.features = buildings.features.map(f => ({
    ...f,
    geometry: reprojectGeometry(f.geometry)
  }));

  map.addSource('buildings', {
    type: 'geojson',
    data: buildings
  });

  map.addLayer({
    id: 'buildings-3d',
    type: 'fill-extrusion',
    source: 'buildings',
    paint: {
      'fill-extrusion-color': '#888',
      'fill-extrusion-height': ['coalesce', ['get', 'height'], 15],
      'fill-extrusion-opacity': 0.9
    }
  });

  /* ---------- Fireworks layer ---------- */

  const fireworksLayer = {
    id: 'fireworks',
    type: 'custom',
    renderingMode: '3d',

    onAdd(map, gl) {
      this.camera = new THREE.Camera();
      this.scene = new THREE.Scene();

      this.renderer = new THREE.WebGLRenderer({
        canvas: map.getCanvas(),
        context: gl,
        antialias: true
      });
      this.renderer.autoClear = false;

      const merc = maplibregl.MercatorCoordinate.fromLngLat(
        [-0.092, 51.515],
        80
      );

      this.scale = merc.meterInMercatorCoordinateUnits();

      this.firework = createFirework(
        new THREE.Vector3(merc.x, merc.y, merc.z)
      );

      this.scene.add(this.firework);
    },

    render(gl, matrix) {
      this.camera.projectionMatrix.fromArray(matrix);

      const pos = this.firework.geometry.attributes.position.array;
      const vel = this.firework.userData.velocities;
      const s = this.scale;

      for (let i = 0; i < vel.length; i++) {
        pos[i * 3]     += vel[i].x * s * 0.03;
        pos[i * 3 + 1] += vel[i].y * s * 0.03;
        pos[i * 3 + 2] += vel[i].z * s * 0.03;

        vel[i].y -= 9.8 * s * 0.01;
      }

      this.firework.geometry.attributes.position.needsUpdate = true;

      this.renderer.resetState();
      this.renderer.render(this.scene, this.camera);
      map.triggerRepaint();
    }
  };

  map.addLayer(fireworksLayer);
});
</script>

</body>
</html>
