<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MapLibre 3D Buildings + Fireworks</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<style>
body { margin: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>

<body>
<div id="map"></div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';

/* --------------------------------------------------
   Map setup
-------------------------------------------------- */

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.openfreemap.org/styles/positron',
  center: [-0.092, 51.515],
  zoom: 16,
  pitch: 60,
  bearing: -20
});

map.addControl(new maplibregl.NavigationControl());

/* --------------------------------------------------
   Firework factory
-------------------------------------------------- */

function createFirework(position, scale) {
  const count = 250;
  const geometry = new THREE.BufferGeometry();
  const positions = new Float32Array(count * 3);
  const velocities = [];
  const life = [];

  for (let i = 0; i < count; i++) {
    positions[i * 3] = 0;
    positions[i * 3 + 1] = 0;
    positions[i * 3 + 2] = 0;

    velocities.push({
      x: (Math.random() - 0.5) * 12,
      y: Math.random() * 14,
      z: (Math.random() - 0.5) * 12
    });

    life.push(1.0);
  }

  geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

  const material = new THREE.PointsMaterial({
    color: new THREE.Color().setHSL(Math.random(), 1, 0.6),
    size: 6,
    transparent: true,
    opacity: 1,
    depthWrite: false,
    sizeAttenuation: false
  });

  const points = new THREE.Points(geometry, material);
  points.position.copy(position);
  points.userData = { velocities, life, scale };

  return points;
}

/* --------------------------------------------------
   Map load
-------------------------------------------------- */

map.on('load', async () => {

  /* ---------- 3D buildings ---------- */

  const proj3857 = proj4('EPSG:3857');
  const proj4326 = proj4('EPSG:4326');

  const reprojectCoord = c => proj4(proj3857, proj4326, c);

  const reprojectGeometry = g => {
    if (g.type === 'Polygon') {
      return { type: 'Polygon', coordinates: g.coordinates.map(r => r.map(reprojectCoord)) };
    }
    if (g.type === 'MultiPolygon') {
      return { type: 'MultiPolygon', coordinates: g.coordinates.map(p => p.map(r => r.map(reprojectCoord))) };
    }
    return g;
  };

  const buildings = await fetch(
    'https://mapsmania.github.io/globalbuilding/building.geojson'
  ).then(r => r.json());

  buildings.features = buildings.features.map(f => ({
    ...f,
    geometry: reprojectGeometry(f.geometry)
  }));

  map.addSource('buildings', {
    type: 'geojson',
    data: buildings
  });

  map.addLayer({
    id: 'buildings-3d',
    type: 'fill-extrusion',
    source: 'buildings',
    paint: {
      'fill-extrusion-color': '#888',
      'fill-extrusion-height': ['coalesce', ['get', 'height'], 15],
      'fill-extrusion-opacity': 0.9
    }
  });

  /* ---------- Fireworks layer ---------- */

  const fireworksLayer = {
    id: 'fireworks',
    type: 'custom',
    renderingMode: '3d',

    onAdd(map, gl) {
      this.camera = new THREE.Camera();
      this.scene = new THREE.Scene();

      this.renderer = new THREE.WebGLRenderer({
        canvas: map.getCanvas(),
        context: gl,
        antialias: true,
        alpha: true
      });

      this.renderer.autoClear = false;
      this.fireworks = [];

      const merc = maplibregl.MercatorCoordinate.fromLngLat(
        [-0.092, 51.515],
        90
      );

      this.scale = merc.meterInMercatorCoordinateUnits();
      this.origin = new THREE.Vector3(merc.x, merc.y, merc.z);

      setInterval(() => {
        const fw = createFirework(this.origin, this.scale);
        this.scene.add(fw);
        this.fireworks.push(fw);
      }, 1200);
    },

    render(gl, matrix) {
      this.camera.projectionMatrix.fromArray(matrix);

      this.renderer.clearDepth();

      for (let f = this.fireworks.length - 1; f >= 0; f--) {
        const fw = this.fireworks[f];
        const pos = fw.geometry.attributes.position.array;
        const vel = fw.userData.velocities;
        const life = fw.userData.life;
        const s = fw.userData.scale;

        let alive = false;

        for (let i = 0; i < vel.length; i++) {
          if (life[i] <= 0) continue;

          pos[i * 3]     += vel[i].x * s * 0.03;
          pos[i * 3 + 1] += vel[i].y * s * 0.03;
          pos[i * 3 + 2] += vel[i].z * s * 0.03;

          vel[i].y -= 9.8 * s * 0.01;
          life[i] -= 0.015;
          alive = true;
        }

        fw.material.opacity -= 0.01;
        fw.geometry.attributes.position.needsUpdate = true;

        if (!alive || fw.material.opacity <= 0) {
          this.scene.remove(fw);
          this.fireworks.splice(f, 1);
        }
      }

      this.renderer.resetState();
      this.renderer.render(this.scene, this.camera);
      map.triggerRepaint();
    }
  };

  // IMPORTANT: fireworks ABOVE buildings
  map.addLayer(fireworksLayer);
});
</script>

</body>
</html>
