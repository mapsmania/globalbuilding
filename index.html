<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>3D Buildings + Basemap</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>

<script>
// Define projections
const proj3857 = proj4('EPSG:3857');
const proj4326 = proj4('EPSG:4326');

// Reproject a single coordinate
function reprojectCoord(coord) {
  return proj4(proj3857, proj4326, coord);
}

// Reproject geometry
function reprojectGeometry(geom) {
  if (geom.type === "Polygon") {
    return { type: "Polygon", coordinates: geom.coordinates.map(ring => ring.map(reprojectCoord)) };
  }
  if (geom.type === "MultiPolygon") {
    return { type: "MultiPolygon", coordinates: geom.coordinates.map(poly => poly.map(ring => ring.map(reprojectCoord))) };
  }
  return geom;
}

// Initialize map
const map = new maplibregl.Map({
    style: 'https://tiles.openfreemap.org/styles/positron',
    center: [13.388, 52.517],
    zoom: 9.5,
    container: 'map',
  })
  
map.on('load', () => {
  fetch("https://mapsmania.github.io/globalbuilding/building.geojson")
    .then(r => r.json())
    .then(data => {
      console.log("Loaded features:", data.features.length);

      // Reproject all features to WGS84
      data.features = data.features.map(f => ({
        ...f,
        geometry: reprojectGeometry(f.geometry)
      }));

      // Add as GeoJSON source
      map.addSource('buildings', { type: 'geojson', data: data });

      // Add 3D extrusion layer
      map.addLayer({
        id: 'buildings-3d',
        type: 'fill-extrusion',
        source: 'buildings',
        paint: {
          'fill-extrusion-color': '#888888',
          'fill-extrusion-height': ['coalesce', ['get', 'height'], 10],
          'fill-extrusion-base': 0,
          'fill-extrusion-opacity': 0.9
        }
      });

      // Add navigation controls
      map.addControl(new maplibregl.NavigationControl());
    });
});
</script>
</body>
</html>
